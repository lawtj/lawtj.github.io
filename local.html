<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark" />
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" /> -->
  <link rel="stylesheet" href="https://lawtj.github.io/pico-tyler-spaced.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <title>Local Anesthetic Calculator</title>
</head>

<body>
  <header class="container">
    <h1 align="center">Local Anesthetic Remaining Calculator</h1>
  </header>
  <main x-data="calcData()">
    <div class="container grid">
      <form onsubmit="handleSubmit(event)">
        <fieldset class="container">
          <label> Patient weight
            <input type="number" name="weight" placeholder="kg" x-model="kgs" />
          </label>
        </fieldset>
        <article class="pico-primary" x-html="textDisplay()"></article>

      </form>
      <div>
        <div>
          <h3 align="center">Amount remaining</h3>
          <table class="striped">
            <thead>
              <tr>
                <th scope="col">Drug</th>
                <th scope="col">Amount remaining (ml)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Lidocaine 1%</th>
                <td x-text="mLremaining('lidocaine1')"></td>
              </tr>
              <tr>
                <td>Lidocaine 2% plain</td>
                <td x-text="mLremaining('lidocaine2')"></td>
              </tr>
              <tr>
                <td>Lidocaine 2% with epi</td>
                <td x-text="mLremaining('lidocaine2epi')"></td>
              </tr>
              <tr>
                <td>Bupivacaine 0.25%</td>
                <td x-text="mLremaining('bupivacaine025')"></td>
              </tr>
              <tr>
                <td>Bupivacaine 0.5%</td>
                <td x-text="mLremaining('bupivacaine05')"></td>
              </tr>
              <tr>
                <td>Ropivacaine 0.5%</td>
                <td x-text="mLremaining('ropi05')"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="container">
      <hr>
      <div class="container grid">

        <form>
          <h3 align="center">Doses given</h3>
          <fieldset>
            <label> Lidocaine 1%
              <input type="number" name="lidocaine1_given" placeholder="ml"
                x-model.number="drugs.lidocaine1.givenDose" />
            </label>
            <label> Lidocaine 2% plain
              <input type="number" name="lidocaine2_given" placeholder="ml"
                x-model.number="drugs.lidocaine2.givenDose" />
            </label>
            <label> Lidocaine 2% with epi
              <input type="number" name="lidocaine2epi_given" placeholder="ml"
                x-model.number="drugs.lidocaine2epi.givenDose" />
            </label>
            <label> Bupivacaine 0.25%
              <input type="number" name="bupivacaine025_given" placeholder="ml"
                x-model.number="drugs.bupivacaine025.givenDose" />
            </label>
            <label> Bupivacaine 0.5%
              <input type="number" name="bupivacaine05_given" placeholder="ml"
                x-model.number="drugs.bupivacaine05.givenDose" />
            </label>
            <label> Ropivacaine 0.5%
              <input type="number" name="ropi05_given" placeholder="ml" x-model.number="drugs.ropi05.givenDose" />
            </label>
          </fieldset>
        </form>
        <details>
          <summary align="center">
            <h3>Toxic doses</h3>
          </summary>
          <form>
            <fieldset>
              <label> Lidocaine 1%
                <input type="number" name="lidocaine1" x-model.number="drugs.lidocaine1.toxicDose" />
                <small>mg/kg</small>
              </label>
              <label> Lidocaine 2% plain
                <input type="number" name="lidocaine2" x-model.number="drugs.lidocaine2.toxicDose" />
                <small>mg/kg</small>

              </label>
              <label> Lidocaine 2% with epi
                <input type="number" name="lidocaine2epi" x-model.number="drugs.lidocaine2epi.toxicDose" />
                <small>mg/kg</small>

              </label>
              <label> Bupivacaine 0.25%
                <input type="number" name="bupivacaine025" x-model.number="drugs.bupivacaine025.toxicDose" />
                <small>mg/kg</small>

              </label>
              <label> Bupivacaine 0.5%
                <input type="number" name="bupivacaine05" x-model.number="drugs.bupivacaine05.toxicDose" />
                <small>mg/kg</small>

              </label>
              <label> Ropivacaine 0.5%
                <input type="number" name="ropi05" x-model.number="drugs.ropi05.toxicDose" />
                <small>mg/kg</small>

              </label>
            </fieldset>
          </form>
        </details>
      </div>
      <hr>
    </div>

  </main>
</body>

<script>
  function calcData() {
    return {
      openExtra: false,
      drugs: {
        lidocaine1: {
          toxicDose: 4.5,
          givenDose: null,
          milligrams: 10,
        },
        lidocaine2: {
          toxicDose: 4.5,
          givenDose: null,
          milligrams: 20,
        },
        lidocaine2epi: {
          toxicDose: 7,
          givenDose: null,
          milligrams: 20,
        },
        bupivacaine025: {
          toxicDose: 2.5,
          givenDose: null,
          milligrams: 2.5,
        },
        bupivacaine05: {
          toxicDose: 2.5,
          givenDose: null,
          milligrams: 5,
        },
        ropi05: {
          toxicDose: 3,
          givenDose: null,
          milligrams: 5,
        },
      },
      kgs: 70,

      getPercentage(drugName) {
        const drug = this.drugs[drugName];
        return (drug.givenDose * drug.milligrams) / (this.kgs * drug.toxicDose);
      },

      percentOfTotal() {
        let totalFrac = 0;
        const drugNames = Object.keys(this.drugs);
        for (const drugName of drugNames) {
          totalFrac += this.getPercentage(drugName);
        }
        return totalFrac;
      },

      mLremaining(drugName) {
        // 1 - total fraction is the percent of total dose left
        // total dose left pct * toxic dose = total dose left in mg
        // total dose left in mg / mg/ml = ml left
        var fracLeft = 1 - this.percentOfTotal();
        var totalDoseLeft = fracLeft * (this.drugs[drugName].toxicDose * this.kgs);
        var mLleft = Math.round(totalDoseLeft / this.drugs[drugName].milligrams);
        return mLleft;
      },

      textDisplay() {
        console.log(this.percentOfTotal());
        if (this.kgs === null) {
          this.openExtra = false;
          return 'Please enter the patient weight';
        } else if (Number.isNaN(this.percentOfTotal())) {
          this.openExtra = false;

          return 'Please enter some anesthetic given';
        } else if (this.percentOfTotal() === 0) {
          this.openExtra = true;
          return 'Please enter some anesthetic given';
        } else if (this.percentOfTotal() > 1) {
          this.openExtra = false;
          return 'You have exceeded the toxic dose of local anesthetic';
        } else if (this.percentOfTotal() > 0) {
          this.openExtra = true;

          return `You have used ${Math.round(this.percentOfTotal() * 100)}% of the toxic dose of local anesthetic`;

        }
      },

    };
  }


</script>

<script>
  function handleSubmit(event) {
      event.preventDefault();  // Prevent form from submitting normally

  }
</script>
</html>
